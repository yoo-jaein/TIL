# JPA and ORM

## JPA
JPA(Java Persistence API)는 자바 ORM 기술에 대한 API 표준 명세다. 쉽게 이야기하면 인터페이스를 모아둔 것이다. 따라서 JPA를 사용하려면 JPA를 구현한 ORM 프레임워크를 선택해야 한다.

## 표준에서 오는 장점
특정 구현 기술에 대한 의존도를 줄일 수 있고 다른 구현 기술로 손쉽게 이동할 수 있다. 따라서 JPA 표준을 먼저 이해하고 필요에 따라 JPA 구현체의 고유한 기능을 학습하면 된다.

## ORM
ORM(Object-Relation Mapping)은 객체와 관계형 데이터베이스를 매핑하는 것이다. ORM 프레임워크는 객체와 테이블을 매핑해서 패러다임 불일치를 해결해준다. 예를 들어 ORM 프레임워크를 사용하면 객체를 데이터베이스에 저장할 때 Insert SQL을 직접 작성하는 것이 아니라, 객체를 ORM 프레임워크에 저장하면 된다. 그러면 ORM 프레임워크가 적절한 Insert SQL을 생성해서 데이터베이스에 객체를 저장해준다.

## Hibernate
자바 진영에는 다양한 ORM 프레임워크가 있다. 그 중 Hibernate가 가장 많이 사용된다.

## 왜 JPA를 사용해야 하는가?
1. 생산성  
JPA를 사용하면 다음 코드처럼 자바 컬렉션에 객체를 저장하듯이 JPA에게 데이터베이스에 저장할 객체를 전달하면 된다. SQL을 작성하고 JDBC API를 사용하는 반복적인 일은 JPA가 개발자 대신 처리해준다.  

    ```java
    jpa.persist(member); //저장
    Member member = jpa.find(memberId); //조회
    ```

2. 유지보수  
SQL을 직접 다루면 엔티티에 필드를 하나만 추가해도 관련된 등록/수정/조회 SQL과 결과 매핑을 위한 JDBC API 코드를 모두 변경해야 한다. 반면에 JPA를 사용하면 이런 과정을 JPA가 대신 처리해주므로 수정해야 할 코드가 줄어든다. 따라서 유지보수해야 하는 코드 수가 줄어든다.  

3. 성능  
JPA는 애플리케이션과 데이터베이스 사이에서 다양한 성능 최적화 기회를 제공한다. 예를 들어 동일한 트랜잭션 안에서 같은 회원을 두 번 조회한다면, JDBC API로 작성한 코드는 데이터베이스와 두 번 통신해야 하지만 JPA는 데이터베이스에 한 번만 SQL을 전달하고 두 번째에는 조회한 회원 객체를 재사용한다.

4. 벤더 독립성  
관계형 데이터베이스는 벤더마다 사용법이 다른 경우가 많다. JPA는 애플리케이션이 특정 데이터베이스 기술에 종속되지 않도록 한다. 만약 데이터베이스를 변경하면 JPA에게 다른 데이터베이스를 사용한다고 알려주기만 하면 된다.  
   
5. 표준
ORM 기술 표준이기 때문에 사용한다. 표준을 사용하면 다른 구현 기술로 손쉽게 바꿀 수 있다.
   
## 성능이 느리진 않을까?
JPA는 다양한 성능 최적화 기능을 제공한다. 그 기능을 잘 이해하고 사용하면 SQL을 직접 사용할 때보다 더 좋은 성능을 낼 수 있다. 하지만 JPA를 잘 이해하지 못하고 사용하면 N+1 같은 문제로 심각한 성능 저하가 발생할 수 있다. 

## N+1 문제
N+1 문제는 SQL 1번으로 회원 100명을 조회했는데, 각 회원마다 주문한 상품을 추가로 조회하기 위해 100번의 SQL을 추가로 실행하는 것을 말한다. 한 번 SQL을 실행해서 조회한 수 만큼 N번 SQL을 추가로 실행한다고 해서 N+1 문제라고 한다. N+1 문제를 해결하는 가장 일반적인 방법은 페치 조인을 사용하는 것이다. 페치 조인은 SQL 조인을 사용해서 연관된 엔티티를 함께 조회하므로 N+1 문제가 발생하지 않는다.

```mysql-sql
-- JPQL
select m from Member m join fetch m.orders;

-- SQL
select m.*, o.* from member m
inner join orders o on m.id = o.member_id;
```

## 마이바티스와 ORM의 차이
마이바티스나 JdbcTemplate을 객체와 SQL을 매핑해주는 SQL 매퍼라 한다. SQL과 매핑할 객체만 지정하면 반복적인 JDBC API 사용과 응답 결과 매핑을 SQL 매퍼가 대신 처리해준다.  

SQL 매퍼가 편리하긴 하지만 결국 개발자가 SQL을 직접 작성해야 하기 때문에 SQL에 의존하는 개발이 된다. ORM의 경우 객체와 테이블을 매핑만하면 ORM 프레임워크가 SQL을 만들어서 데이터베이스와 관련된 처리를 해주기 때문에 SQL에 의존하는 개발을 피할 수 있다.  

## 참고
자바 ORM 표준 JPA 프로그래밍 1장  
