# Load Balancing

## 로드 밸런싱
로드 밸런싱(Load Balancing, 부하 분산)이란 서버에 가해지는 트래픽을 분산시켜주는 기술을 의미한다. 클라이언트와 서버 그룹(분산 네트워크) 사이에 로드 밸런서가 위치하며, 로드 밸런서는 한 서버로 부하가 집중되지 않도록 트래픽을 여러 대의 서버로 균등하게 분산시켜준다. 스케일 아웃으로 서버를 확장한다면 로드 밸런싱이 반드시 필요하다. 

## 로드 밸런서 종류
로드 밸런서는 L2, L3, L4, L7로 나뉜다. L4 로드 밸런서와 L7 로드 밸런서가 가장 많이 활용된다. 그 이유는 L4 로드 밸런서부터 포트 정보를 바탕으로 로드를 분산하는 것이 가능하기 때문이다. (한 대의 서버에 각기 다른 포트 번호를 부여하는 다수의 서버 프로그램을 운영하는 경우라면 최소 L4 로드 밸런서 이상을 사용해야 한다.) N번 계층을 이용하는 로드 밸런서는 N-1번 이하의 계층 정보를 모두 이용할 수 있다.

## 장점
1대의 서버 장애가 발생하여도 서비스 중단없이 다른 서버로 적절히 트래픽을 분배하여 서비스를 계속 제공할 수 있다. (어떤 서버가 다운되면 로드 밸런서는 트래픽을 나머지 온라인 서버로 redirect한다.) 사용량이 많아져서 서버를 증설할 때도 서비스 중단없이 증설이 가능하다. (로드 밸런서가 온라인 상태가 된 서버에 자동으로 요청 전송을 시작한다.) 로드 밸런서 안쪽의 내부 네트워크 구조를 숨겨서 보안성도 높일 수 있다.

## 단점
로드 밸런서를 사용할 때 어려운 문제 중 하나가 세션 데이터를 관리하는 것이다. 클라이언트의 연결 정보를 저장하는 세션이 로드 밸런싱을 통해 하나의 서버 장비에 저장이 되는 경우, 추후 다른 서버로 접속하게 되면, 해당 클라이언트의 세션이 유지되지 않는다는 것이다. 서버에 액세스할 때마다 다른 세션을 사용한다면 특정 사용자의 정보를 일관성 있게 유지할 수 없게 된다. 이러한 문제를 해결하기 위해 세션을 고정한다. 이 방법으로 특정 사용자의 요청이 전달될 노드를 고정할 수 있지만 고정된 세션의 노드에 장애가 발생하면 고정한 의미가 없어진다.

### L2 로드 밸런서
- 데이터 링크 계층(Data Link Layer, L2)까지 정의된 정보를 바탕으로 로드 밸런싱한다.
- MAC 주소를 이용하여 전달할 서버를 결정한다. 
- L2 로드 밸런서를 사용하면 로드 밸런서와 서버가 반드시 같은 네트워크에 속해야 한다.

### L3 로드 밸런서
- 네트워크 계층(Network Layer, L3)까지 정의된 정보를 바탕으로 로드 밸런싱한다.
- 포트 간 패킷 스위칭을 통해 IP 주소를 기반으로 스위칭한다. 

### L4 로드 밸런서
- 전송 계층(Transport Layer, L4)까지 정의된 정보를 바탕으로 로드 밸런싱한다.
- IP 주소와 포트 번호, MAC 주소, 전송 프로토콜에 따라 트래픽을 나눈다.

### L7 로드 밸런서
- 애플리케이션 계층(Application Layer, L7)까지 정의된 정보를 바탕으로 로드 밸런싱한다.
- 가장 섬세한 라우팅이 가능하다. 패킷의 정보를 확인하고 그 내용에 따라 로드 밸런싱할 수 있다. URL에 따라 부하를 분산시키거나, HTTP 헤더의 쿠키값에 따라 부하를 분산시킬 수 있다.

## 로드 밸런싱 알고리즘
부하를 분산하는 방식은 정적 로드 밸런싱(Static load balancing)과 동적 로드 밸런싱(Dynamic load balancing)으로 나뉜다.
- 동적 부하 분산은 각 서버의 현재 상태를 고려하고 그에 따라 트래픽을 분산하는 알고리즘을 사용한다.
- 정적 부하 분산은 이러한 조정 없이 트래픽을 분산한다.

### 정적 로드 밸런싱
#### 라운드로빈 방식(Round Robin)
- 서버에 들어온 요청을 순서대로 돌아가며 배정하는 방식
- 클라이언트의 요청을 순서대로 분배하기 때문에 여러 대의 서버가 동일한 스펙을 갖고 있으며, 서버와의 연결(세션)이 오래 지속되지 않는 경우에 적합

#### 가중 라운드로빈 방식(Weighted Round Robin)
- 각각의 서버마다 가중치를 매기고 가중치가 높은 서버에 클라이언트 요청을 우선적으로 배정하는 방식
- 각 서버의 트래픽 처리 능력이 상이한 경우에 적합

#### IP 해시 방식(IP Hash)
- 클라이언트의 IP 주소를 특정 서버로 매핑해 요청을 처리하는 방식
- 사용자의 IP를 해싱해 로드를 분배하기 때문에 사용자가 항상 동일한 서버로 연결되는 것을 보장

### 동적 로드 밸런싱
### 최초 연결 방식(Least Connection)
- 요청이 들어온 시점에 가장 적은 연결상태를 보이는 서버에 우선적으로 트래픽을 배정하는 방식
- 자주 세션이 길어지거나 서버에 분배된 트래픽이 일정하지 않은 경우에 적합

### 최소 응답시간(Least Response Time)
- 서버의 현재 연결 상태와 응답시간을 모두 고려해 트래픽을 배정하는 방식
- 가장 적은 연결 상태와 가장 짧은 응답시간을 보이는 서버에 우선적으로 로드를 배분

## 참고
https://ko.wikipedia.org/wiki/%EB%B6%80%ED%95%98%EB%B6%84%EC%82%B0  
https://post.naver.com/viewer/postView.nhn?volumeNo=27046347&memberNo=2521903  
http://www.incodom.kr/Load_Balancing  
https://pakss328.medium.com/%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%84%9C%EB%9E%80-l4-l7-501fd904cf05  